<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Career Growth (CGI) Calculator – KW Explore</title>

  <!-- Tailwind & jsPDF -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: dark; }
    body{font-family:'Inter',sans-serif;background:#333;color:#fff}
    .card{background:#1a1a1a;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    .input-grey{background:#4a4a4a;color:#fff;border-color:#6b7280}
    .input-grey::placeholder{color:#a0aec0}
    .input-red{background:#991b1b;color:#fff;font-weight:700;border-color:#ef4444}
    .header-bg{background:#000}
    h1,h2,h3{color:#ef4444}
    .btn{background:#ef4444;transition:background-color .3s}
    .btn:hover{background:#dc2626}
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}
  </style>
</head>
<body class="p-4 sm:p-8">

  <!-- Calculator -->
  <div id="calculatorWrapper">
    <div class="card max-w-4xl mx-auto p-6 sm:p-8 space-y-8">
      <div class="text-center">
        <h1 class="text-3xl font-bold mb-2">Your Career Growth (CGI) Calculator</h1>
        <p class="text-gray-300">After your cost of sales, expenses, and taxes, what amount of profit would fund the life you want this year?</p>
      </div>

      <!-- Your Details -->
      <section class="space-y-4">
        <h2 class="text-2xl font-semibold border-b-2 border-gray-700 pb-2">Your Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input id="name"    type="text"   placeholder="Name"           class="w-full p-3 rounded-md input-grey">
          <input id="surname" type="text"   placeholder="Surname"        class="w-full p-3 rounded-md input-grey">
          <input id="email"   type="email"  placeholder="Email Address"  class="w-full p-3 rounded-md input-grey">
          <input id="contact" type="tel"    placeholder="Contact Number" class="w-full p-3 rounded-md input-grey">
        </div>
        <p class="text-center text-gray-400 italic mt-2">Complete the grey fields — red fields auto-calculate.</p>
      </section>

      <!-- Calculator Inputs -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-6">
          <div class="space-y-2">
            <label for="profitGoal" class="font-medium">Profit Goal</label>
            <input id="profitGoal" type="number" min="0" step="any" placeholder="1000000" class="w-full p-3 rounded-md input-grey">
          </div>

          <h3 class="text-xl font-semibold border-b border-gray-600 pb-2">Cost of Sales</h3>

          <div class="grid grid-cols-2 gap-4 items-end">
            <div>
              <label for="averageSalePrice" class="text-sm">Average Sale Price</label>
              <input id="averageSalePrice" type="number" min="0" step="any" placeholder="1500000" class="w-full p-2 rounded-md input-grey mt-1">
            </div>
            <div>
              <label for="splitToMarketCenter" class="text-sm">Split to Market Center %</label>
              <input id="splitToMarketCenter" type="number" min="0" step="any" placeholder="30" class="w-full p-2 rounded-md input-grey mt-1">
            </div>
            <div>
              <label for="averageCommissionRate" class="text-sm">Average Commission Rate %</label>
              <input id="averageCommissionRate" type="number" min="0" step="any" placeholder="5.5" class="w-full p-2 rounded-md input-grey mt-1">
            </div>
            <div>
              <label for="franchiseFeeRate" class="text-sm">Franchise Fee Rate %</label>
              <input id="franchiseFeeRate" type="number" min="0" step="any" placeholder="8" class="w-full p-2 rounded-md input-grey mt-1">
            </div>
            <div>
              <label for="companyCurrencyCap" class="text-sm">Company Currency Cap</label>
              <input id="companyCurrencyCap" type="number" min="0" step="any" placeholder="210000" class="w-full p-2 rounded-md input-grey mt-1">
            </div>
            <div>
              <label for="anticipatedTransactions" class="text-sm">Anticipated No. of Trans/Yr</label>
              <input id="anticipatedTransactions" type="number" min="0" step="1" placeholder="24" class="w-full p-2 rounded-md input-grey mt-1">
            </div>
          </div>

          <div class="grid grid-cols-1 gap-4">
            <label class="text-sm text-gray-400">Tax (auto-calculated @ 25%)</label>
            <input id="tax" type="text" class="w-full p-2 rounded-md input-red" readonly>
          </div>
        </div>

        <div class="space-y-4">
          <h3 class="text-xl font-semibold border-b border-gray-600 pb-2">Calculated Values</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm">Avg Commission/Trans</label>
              <input id="avgCommissionPerTrans" type="text" class="w-full p-2 rounded-md input-red mt-1" readonly>
            </div>
            <div>
              <label class="text-sm">Avg Split Paid/Trans</label>
              <input id="avgSplitPaidPerTrans" type="text" class="w-full p-2 rounded-md input-red mt-1" readonly>
            </div>
            <div>
              <label class="text-sm">Avg Franchise Fee Paid/Trans</label>
              <input id="avgFranchiseFeePaid" type="text" class="w-full p-2 rounded-md input-red mt-1" readonly>
            </div>
          </div>

          <div>
            <label for="expenses" class="font-medium">Monthly Salaries & Operating Expenses</label>
            <input id="expenses" type="number" min="0" step="any" placeholder="30000" class="w-full p-3 rounded-md input-grey mt-1">
            <label class="text-sm text-gray-400 mt-2 block">Estimated Yearly Expenses</label>
            <input id="yearlyExpenses" type="text" class="w-full p-2 rounded-md input-red mt-1" readonly>
          </div>
          <div>
            <label class="text-sm text-gray-400">Total Estimated Cost of Sales per Year</label>
            <input id="totalCostOfSales" type="text" class="w-full p-2 rounded-md input-red mt-1" readonly>
          </div>
        </div>
      </section>

      <!-- GCI -->
      <section class="header-bg p-4 rounded-lg space-y-4 text-center">
        <h2 class="text-2xl font-bold">Total Estimated Gross Commission Income</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-md mx-auto">
          <div>
            <p class="font-medium">GCI Goal for the Year</p>
            <input id="gciGoalYear" type="text" class="w-full p-3 rounded-md input-red text-center text-xl" readonly>
          </div>
          <div>
            <p class="font-medium">GCI Goal for the Month</p>
            <input id="gciGoalMonth" type="text" class="w-full p-3 rounded-md input-red text-center text-xl" readonly>
          </div>
        </div>
      </section>

      <!-- Activity Goals -->
      <section class="space-y-6">
        <h2 class="text-2xl font-semibold border-b-2 border-gray-700 pb-2">Activity Goals to Reach Your GCI</h2>

        <!-- Registrations -->
        <div>
          <h3 class="text-xl font-semibold mb-2">Registrations (Listings/Buyers)</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <p class="font-medium">Registered / Year</p>
              <input id="registeredYear" type="text" class="w-full p-3 rounded-md input-red mt-1" readonly>
            </div>
            <div>
              <p class="font-medium">Registered / Month</p>
              <input id="registeredMonth" type="text" class="w-full p-3 rounded-md input-red mt-1" readonly>
            </div>
          </div>
        </div>

        <!-- Listings Taken -->
        <div>
          <h3 class="text-xl font-semibold mb-2">Listings Taken</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
            <div class="space-y-4">
              <div>
                <label class="font-medium">% of Business that is Seller Focused</label>
                <input id="sellerFocused" type="number" min="0" step="any" placeholder="50" class="w-full p-3 rounded-md input-grey mt-1">
              </div>
              <div>
                <label class="font-medium">Listings taken → listings closed ratio %</label>
                <input id="listingsToClosedRatio" type="number" min="0" step="any" placeholder="50" class="w-full p-3 rounded-md input-grey mt-1">
              </div>
            </div>
            <div class="space-y-4">
              <div>
                <p class="font-medium">Listings Taken / Year Needed</p>
                <input id="listingsTakenYear" type="text" class="w-full p-3 rounded-md input-red mt-1" readonly>
              </div>
              <div>
                <p class="font-medium">Listings Taken / Month Needed</p>
                <input id="listingsTakenMonth" type="text" class="w-full p-3 rounded-md input-red mt-1" readonly>
              </div>
              <div>
                <p class="font-medium">Closed Listings / Year</p>
                <input id="closedListingsYear" type="text" class="w-full p-3 rounded-md input-red mt-1" readonly>
              </div>
            </div>
          </div>
        </div>

        <!-- Appointments -->
        <div>
          <h3 class="text-xl font-semibold mb-2">Listing Appointments</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
            <div>
              <label class="font-medium">Appointments → taken ratio %</label>
              <input id="appointmentsToTakenRatio" type="number" min="0" step="any" placeholder="80" class="w-full p-3 rounded-md input-grey mt-1">
            </div>
            <div class="space-y-4">
              <div>
                <p class="font-medium">Appointments / Year</p>
                <input id="appointmentsYear" type="text" class="w-full p-3 rounded-md input-red mt-1" readonly>
              </div>
              <div>
                <p class="font-medium">Appointments / Month</p>
                <input id="appointmentsMonth" type="text" class="w-full p-3 rounded-md input-red mt-1" readonly>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Recap -->
      <section class="header-bg p-6 rounded-lg text-center">
        <h2 class="text-2xl font-bold mb-4">Recap — Your Monthly Goals</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-3xl mx-auto">
          <div>
            <p class="font-medium">Listings Appts</p>
            <input id="recapAppointments" type="text" class="w-full p-3 rounded-md input-red text-center text-xl" readonly>
          </div>
          <div>
            <p class="font-medium">Listings Taken</p>
            <input id="recapListingsTaken" type="text" class="w-full p-3 rounded-md input-red text-center text-xl" readonly>
          </div>
          <div>
            <p class="font-medium">Registered</p>
            <input id="recapRegistered" type="text" class="w-full p-3 rounded-md input-red text-center text-xl" readonly>
          </div>
          <div>
            <p class="font-medium">GCI Goal</p>
            <input id="recapGciGoal" type="text" class="w-full p-3 rounded-md input-red text-center text-xl" readonly>
          </div>
        </div>
      </section>

      <!-- Submit -->
      <div class="text-center pt-2">
        <button id="submitBtn" class="btn text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg">
          Get My Personalised Report
        </button>
        <p id="statusMessage" class="mt-4 text-sm"></p>
      </div>
    </div>
  </div>

  <!-- Thank You Screen -->
  <div id="thankYouScreen" class="hidden">
    <div class="card max-w-2xl mx-auto p-8 text-center space-y-6">
      <h1 class="text-4xl font-bold">Thank You!</h1>
      <p class="text-xl text-gray-300">We’ve received your details.</p>
      <p class="text-lg text-gray-400">Check your inbox for your personalised report.</p>
      <div class="border-t border-gray-700 pt-6">
        <p class="text-gray-300">Questions? Contact:</p>
        <a href="mailto:dawie.dutoit@kwsa.co.za" class="text-xl text-red-500 hover:text-red-400">dawie.dutoit@kwsa.co.za</a>
      </div>
    </div>
  </div>

  <script>
    // Latest Web App URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzoihBNyExYkoustGcuPhK0U7k72oKKCOFy2zZR6fFWqTiJk7R9BJpXPHwnizTLbEQuyQ/exec";

    document.addEventListener('DOMContentLoaded', () => {
      // Recalculate on input
      document.querySelectorAll('input[type="number"]').forEach(el => el.addEventListener('input', calculate));
      calculate();

      const { jsPDF } = window.jspdf;
      const submitBtn = document.getElementById('submitBtn');
      const statusMessage = document.getElementById('statusMessage');

      submitBtn.addEventListener('click', onSubmit);

      async function onSubmit() {
        const name = val('name').trim();
        const surname = val('surname').trim();
        const email = val('email').trim();
        const contact = val('contact').trim();

        if (!name || !surname || !email || !contact) return flash("Please fill in all your details first.", false);
        if (!/^https?:\/\//i.test(SCRIPT_URL))     return flash("SCRIPT_URL is not configured correctly.", false);

        flash("Submitting…", null);
        submitBtn.disabled = true;

        // Build PDF
        const doc = new jsPDF();
        doc.setFillColor(239, 68, 68);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setFontSize(22);
        doc.setTextColor(255, 255, 255);
        doc.text("Your Personalised CGI Report", 105, 18, { align: 'center' });
        doc.setFontSize(14);
        doc.text(`For: ${name} ${surname}`, 105, 26, { align: 'center' });

        let y = 45;
        const addSection = (title, items) => {
          doc.setFontSize(16); doc.setTextColor(0,0,0);
          doc.text(title, 14, y); doc.setLineWidth(0.5); doc.line(14, y+2, 196, y+2);
          y += 10; doc.setFontSize(12);
          items.forEach(({label,value}) => { doc.setTextColor(100,116,139); doc.text(label, 20, y); doc.setTextColor(0,0,0); doc.text(value, 190, y, { align:'right' }); y += 8; });
          y += 8;
        };

        addSection("Your Goals", [
          { label: "Profit Goal:",      value: getVal('profitGoal', true) },
          { label: "Yearly GCI Goal:",  value: getVal('gciGoalYear', true) },
          { label: "Monthly GCI Goal:", value: getVal('gciGoalMonth', true) }
        ]);
        addSection("Monthly Activity Plan", [
          { label: "Listings Appointments / Month:", value: getVal('recapAppointments') },
          { label: "Listings Taken / Month:",        value: getVal('recapListingsTaken') },
          { label: "Registered / Month:",            value: getVal('recapRegistered') }
        ]);

        doc.setFontSize(10); doc.setTextColor(150,150,150);
        doc.text("Report generated by the CGI Calculator (KW Explore).", 105, 285, { align:'center' });

        const pdfBase64 = doc.output('datauristring').split(',')[1];

        const payload = {
          name, surname, email, contact,
          profitGoal:        getVal('profitGoal', true),
          gciGoalYear:       getVal('gciGoalYear', true),
          gciGoalMonth:      getVal('gciGoalMonth', true),
          recapAppointments: getVal('recapAppointments'),
          recapListingsTaken:getVal('recapListingsTaken'),
          recapRegistered:   getVal('recapRegistered'),
          pdfBase64,
          fileName: `CGI_Report_${name}_${surname}.pdf`
        };

        try {
          const res  = await fetch(SCRIPT_URL, { method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify(payload) });
          const text = await res.text();
          const data = safeJson(text);

          if (res.ok && data.result === 'success') {
            document.getElementById('calculatorWrapper').style.display = 'none';
            document.getElementById('thankYouScreen').classList.remove('hidden');
          } else {
            throw new Error(data.message || `HTTP ${res.status}`);
          }
        } catch (err) {
          console.error(err);
          flash(`Submission failed: ${err.message}`, false);
          submitBtn.disabled = false;
        }
      }

      function flash(msg, ok) {
        statusMessage.textContent = msg;
        statusMessage.style.color = ok === null ? "#60a5fa" : ok ? "#34d399" : "#f87171";
      }
    });

    // ---------- Helpers ----------
    const val = id => document.getElementById(id)?.value || "";
    const ZA  = new Intl.NumberFormat('en-ZA', { maximumFractionDigits: 0 });
    const formatCurrency = n => isNaN(n)||n===null ? "R 0" : "R " + ZA.format(n);
    const safeJson = t => { try { return JSON.parse(t); } catch { return { result:'error', message:t||'Non-JSON response' }; } };

    const getVal = (id, currency=false) => {
      const el = document.getElementById(id); if (!el) return currency ? "R 0" : 0;
      let v = el.value || el.placeholder || '0';
      v = String(v).replace(/R|\s/g, ''); const n = parseFloat(v.replace(/,/g, ''));
      return currency ? formatCurrency(isNaN(n) ? 0 : n) : (isNaN(n) ? 0 : n);
    };

    const getNum = (id) => {
      const el = document.getElementById(id); if (!el) return 0;
      let v = el.value || el.placeholder || '0';
      v = String(v).replace(/R|\s/g, ''); return parseFloat(v.replace(/,/g, '')) || 0;
    };

    const setVal = (id, value, currency=false) => {
      const el = document.getElementById(id); if (el) el.value = currency ? formatCurrency(value) : value;
    };

    function calculate() {
      const profitGoal = getNum('profitGoal');
      const avgSale    = getNum('averageSalePrice');
      const commRate   = getNum('averageCommissionRate') / 100;
      const cap        = getNum('companyCurrencyCap');
      const txPerYear  = getNum('anticipatedTransactions');
      const splitPct   = getNum('splitToMarketCenter') / 100;
      const royaltyPct = getNum('franchiseFeeRate') / 100;
      const expenses   = getNum('expenses');

      const sellerPct     = getNum('sellerFocused') / 100;
      const takenToClosed = getNum('listingsToClosedRatio') / 100;
      const apptToTaken   = getNum('appointmentsToTakenRatio') / 100;

      // Tax
      const tax = profitGoal * 0.25;

      // Commission per transaction
      const avgCommissionPerTrans = avgSale * commRate;
      const avgSplitPaidPerTrans  = avgCommissionPerTrans * splitPct;
      const avgRoyaltyPerTrans    = avgCommissionPerTrans * royaltyPct;

      // Year totals
      const totalSplitYear   = avgSplitPaidPerTrans * txPerYear;
      const totalRoyaltyYear = avgRoyaltyPerTrans * txPerYear;

      // Cap applies to company split only
      const splitAfterCap    = Math.min(totalSplitYear, cap || 0);
      const totalCostOfSales = txPerYear > 0 ? (splitAfterCap + totalRoyaltyYear) : 0;

      const yearlyExpenses = expenses * 12;

      const gciGoalYear  = profitGoal + tax + totalCostOfSales + yearlyExpenses;
      const gciGoalMonth = gciGoalYear / 12;

      // Production math
      const registeredYear  = avgCommissionPerTrans > 0 ? Math.ceil(gciGoalYear / avgCommissionPerTrans) : 0;
      const registeredMonth = registeredYear > 0 ? Math.ceil(registeredYear / 12) : 0;

      const closedYear = (registeredYear > 0 && sellerPct > 0) ? Math.ceil(registeredYear * sellerPct) : 0;
      const takenYear  = (closedYear > 0 && takenToClosed > 0) ? Math.ceil(closedYear / takenToClosed) : 0;
      const takenMonth = takenYear > 0 ? Math.ceil(takenYear / 12) : 0;

      const apptYear   = (takenYear > 0 && apptToTaken > 0) ? Math.ceil(takenYear / apptToTaken) : 0;
      const apptMonth  = apptYear > 0 ? Math.ceil(apptYear / 12) : 0;

      // Outputs
      setVal('tax', tax, true);
      setVal('avgCommissionPerTrans', avgCommissionPerTrans, true);
      setVal('avgSplitPaidPerTrans',  avgSplitPaidPerTrans,  true);
      setVal('avgFranchiseFeePaid',   avgRoyaltyPerTrans,    true);
      setVal('totalCostOfSales',      totalCostOfSales,      true);
      setVal('yearlyExpenses',        yearlyExpenses,        true);
      setVal('gciGoalYear',           gciGoalYear,           true);
      setVal('gciGoalMonth',          gciGoalMonth,          true);

      setVal('registeredYear',  registeredYear);
      setVal('registeredMonth', registeredMonth);
      setVal('closedListingsYear', closedYear);
      setVal('listingsTakenYear',  takenYear);
      setVal('listingsTakenMonth', takenMonth);
      setVal('appointmentsYear',   apptYear);
      setVal('appointmentsMonth',  apptMonth);

      setVal('recapAppointments', apptMonth);
      setVal('recapListingsTaken', takenMonth);
      setVal('recapRegistered', registeredMonth);
      setVal('recapGciGoal', gciGoalMonth, true);
    }
  </script>
</body>
</html>

